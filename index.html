<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PinSwap</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 980px; margin: 30px auto; padding: 0 16px; }
    h2 { margin: 18px 0 10px; }
    input, select { padding: 10px; margin: 6px 6px 6px 0; min-width: 170px; }
    button { padding: 10px 12px; margin: 6px 6px 6px 0; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .muted { color: #666; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 10px 0; }
    .row { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; }
    .col { display:flex; flex-direction:column; gap:8px; }
    #inventoryList .card { max-width: 820px; }
    .danger { color: #a00; }
    .pill { display:inline-block; padding:3px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; color:#555; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 860px) { .grid2 { grid-template-columns: 1fr; } }
    .stat { border:1px solid #eee; border-radius:12px; padding:10px 12px; }
    .stat b { font-size:18px; }
    .tradeBox { border:1px solid #eee; border-radius:12px; padding:12px; }
    .small { font-size: 12px; }
    img.preview { max-width:220px; border:1px solid #eee; border-radius:10px; margin-top:6px; display:none; }
  </style>
</head>
<body>

  <h2>Sign in</h2>
  <div class="row">
    <input id="authEmail" placeholder="Email" />
    <input id="authPassword" placeholder="Password" type="password" />
    <button id="signUpBtn">Sign Up</button>
    <button id="signInBtn">Sign In</button>
    <button id="signOutBtn" style="display:none;">Sign Out</button>
  </div>
  <div id="authStatus" class="muted" style="margin:8px 0;"></div>

  <hr/>

  <h2>Inventory <span id="modePill" class="pill">Add mode</span></h2>

  <div class="row">
    <div class="stat"><div class="muted small">Unique pins</div><b id="statUnique">-</b></div>
    <div class="stat"><div class="muted small">Total qty</div><b id="statQty">-</b></div>
    <div class="stat"><div class="muted small">Total est value</div><b id="statValue">-</b></div>
  </div>

  <!-- NEW: Refresh selected values -->
  <div class="row">
    <button id="refreshSelectedBtn" disabled>Refresh selected values</button>
    <div id="refreshStatus" class="muted small"></div>
  </div>

  <div class="row">
    <input id="pinIdInput" placeholder="Pin ID (required)" />
    <input id="nameInput" placeholder="Name (required)" />
    <input id="setInput" placeholder="Set Name" />
    <input id="yearInput" placeholder="Year" type="number" />
    <input id="qtyInput" placeholder="Qty" type="number" value="1" />
    <input id="valueInput" placeholder="Est Value" type="number" />
    <select id="conditionInput">
      <option value="">Condition (optional)</option>
      <option value="mint">Mint</option>
      <option value="near_mint">Near Mint</option>
      <option value="used">Used</option>
    </select>

    <button id="addPinBtn" disabled>Add Pin</button>
    <button id="cancelEditBtn" style="display:none;">Cancel</button>
  </div>

  <div class="row">
    <input id="photoInput" type="file" accept="image/*" />
    <button id="uploadPhotoBtn" disabled>Upload Photo</button>
    <button id="searchMatchBtn" disabled>Search match (stub)</button>
  </div>

  <div id="addPinStatus" class="muted" style="margin:8px 0;"></div>
  <div id="photoStatus" class="muted small" style="margin:6px 0;"></div>
  <img id="photoPreview" class="preview" />

  <hr/>

  <h2>Trade Calculator (3-for-3)</h2>
  <div class="grid2">
    <div class="tradeBox">
      <h3 style="margin:0 0 8px;">My pins (select up to 3)</h3>
      <div id="myTradeList" class="muted">Select pins from your inventory below.</div>
      <div class="row" style="margin-top:10px;">
        <div class="stat" style="min-width: 180px;">
          <div class="muted small">My total</div>
          <b id="myTotal">$0</b>
        </div>
      </div>
    </div>

    <div class="tradeBox">
      <h3 style="margin:0 0 8px;">Their pins (add up to 3)</h3>

      <div class="row">
        <input id="theirPinId" placeholder="Their Pin ID (required)" />
        <input id="theirName" placeholder="Name" />
        <input id="theirValue" placeholder="Est Value" type="number" />
        <button id="addTheirBtn">Add</button>
      </div>

      <div id="theirTradeList" class="muted">No pins added yet.</div>

      <div class="row" style="margin-top:10px;">
        <div class="stat" style="min-width: 180px;">
          <div class="muted small">Their total</div>
          <b id="theirTotal">$0</b>
        </div>
      </div>
    </div>
  </div>

  <div class="tradeBox" style="margin-top:16px;">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="muted small">Fairness</div>
        <b id="fairnessText">â€”</b>
        <div id="fairnessDetail" class="muted small"></div>
      </div>
      <div class="row">
        <button id="resetTradeBtn">Reset Trade</button>
        <button id="completeTradeBtn" disabled>Complete Trade</button>
      </div>
    </div>
    <div class="muted small" style="margin-top:8px;">
      Note: This uses your stored estimated values. This is an estimate, not a guarantee.
    </div>
  </div>

  <hr/>

  <h2>My Inventory (click card to edit)</h2>
  <div id="inventoryList" class="muted">Sign in to see your inventory.</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  deleteDoc,
  collection,
  serverTimestamp,
  query,
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import {
  getStorage,
  ref as storageRef,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";
import {
  getFunctions,
  httpsCallable
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-functions.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3iceZJjmX-bs0F0pszXMf1J6wnatCPCA",
  authDomain: "pinswap22.firebaseapp.com",
  projectId: "pinswap22",
  storageBucket: "pinswap22.firebasestorage.app",
  messagingSenderId: "81587095201",
  appId: "1:81587095201:web:a6ff58e40d7decc41d2e0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const functions = getFunctions(app);
const refreshPinValue = httpsCallable(functions, "refreshPinValue");

// --- UI refs ---
const authEmail = document.getElementById("authEmail");
const authPassword = document.getElementById("authPassword");
const signUpBtn = document.getElementById("signUpBtn");
const signInBtn = document.getElementById("signInBtn");
const signOutBtn = document.getElementById("signOutBtn");
const authStatus = document.getElementById("authStatus");

const pinIdInput = document.getElementById("pinIdInput");
const nameInput = document.getElementById("nameInput");
const setInput = document.getElementById("setInput");
const yearInput = document.getElementById("yearInput");
const qtyInput = document.getElementById("qtyInput");
const valueInput = document.getElementById("valueInput");
const conditionInput = document.getElementById("conditionInput");
const addPinBtn = document.getElementById("addPinBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const addPinStatus = document.getElementById("addPinStatus");
const modePill = document.getElementById("modePill");

const photoInput = document.getElementById("photoInput");
const uploadPhotoBtn = document.getElementById("uploadPhotoBtn");
const searchMatchBtn = document.getElementById("searchMatchBtn");
const photoStatus = document.getElementById("photoStatus");
const photoPreview = document.getElementById("photoPreview");

const refreshSelectedBtn = document.getElementById("refreshSelectedBtn");
const refreshStatus = document.getElementById("refreshStatus");

const inventoryEl = document.getElementById("inventoryList");
const statUnique = document.getElementById("statUnique");
const statQty = document.getElementById("statQty");
const statValue = document.getElementById("statValue");

// Trade UI
const myTradeList = document.getElementById("myTradeList");
const theirTradeList = document.getElementById("theirTradeList");
const myTotalEl = document.getElementById("myTotal");
const theirTotalEl = document.getElementById("theirTotal");
const fairnessText = document.getElementById("fairnessText");
const fairnessDetail = document.getElementById("fairnessDetail");
const addTheirBtn = document.getElementById("addTheirBtn");
const resetTradeBtn = document.getElementById("resetTradeBtn");
const completeTradeBtn = document.getElementById("completeTradeBtn");

const theirPinId = document.getElementById("theirPinId");
const theirName = document.getElementById("theirName");
const theirValue = document.getElementById("theirValue");

// --- state ---
let uid = null;
let unsubscribeInventory = null;
let editingPinId = null;
let inventoryMap = new Map();
let mySelectedIds = [];
let theirPins = [];

// NEW: refresh selection set
let refreshSelectedIds = new Set();

// --- helpers ---
function numOrNull(value) {
  const t = String(value ?? "").trim();
  if (!t) return null;
  const n = Number(t);
  return Number.isFinite(n) ? n : null;
}
function fmtMoney(n) {
  const v = Number(n || 0);
  return "$" + v.toFixed(2);
}
function fmtCond(c) {
  if (!c) return "-";
  return String(c).replace("_", " ");
}
function setAddEnabled(enabled) {
  addPinBtn.disabled = !enabled;
  uploadPhotoBtn.disabled = !enabled;
  searchMatchBtn.disabled = !enabled;
  refreshSelectedBtn.disabled = !enabled || refreshSelectedIds.size === 0;
  if (!enabled) {
    addPinStatus.textContent = "";
    refreshStatus.textContent = "";
  }
}
function setFormMode(docId) {
  editingPinId = docId || null;
  addPinBtn.textContent = editingPinId ? "Save Changes" : "Add Pin";
  cancelEditBtn.style.display = editingPinId ? "inline-block" : "none";
  modePill.textContent = editingPinId ? "Edit mode" : "Add mode";
  pinIdInput.disabled = !!editingPinId;

  const effectiveId = (editingPinId || (pinIdInput.value || "").trim());
  uploadPhotoBtn.disabled = !uid || !effectiveId;
  searchMatchBtn.disabled = !uid || !effectiveId;
}
function clearForm() {
  pinIdInput.value = "";
  nameInput.value = "";
  setInput.value = "";
  yearInput.value = "";
  qtyInput.value = "1";
  valueInput.value = "";
  conditionInput.value = "";
  photoInput.value = "";
  photoStatus.textContent = "";
  photoPreview.src = "";
  photoPreview.style.display = "none";
}
function fillFormFromDoc(docId, item) {
  pinIdInput.value = docId;
  nameInput.value = item?.name ?? "";
  setInput.value = item?.setName ?? "";
  yearInput.value = item?.year ?? "";
  qtyInput.value = item?.qty ?? 1;
  valueInput.value = item?.estValue ?? "";
  conditionInput.value = item?.condition ?? "";
  photoInput.value = "";
  photoStatus.textContent = "";
  if (item?.photoUrl) {
    photoPreview.src = item.photoUrl;
    photoPreview.style.display = "block";
  } else {
    photoPreview.src = "";
    photoPreview.style.display = "none";
  }
}
function updateTotalsFromInventory() {
  const unique = inventoryMap.size;
  let totalQty = 0;
  let totalValue = 0;
  for (const [, item] of inventoryMap) {
    const q = Number(item.qty ?? 1) || 1;
    const v = Number(item.estValue ?? 0) || 0;
    totalQty += q;
    totalValue += (v * q);
  }
  statUnique.textContent = String(unique);
  statQty.textContent = String(totalQty);
  statValue.textContent = fmtMoney(totalValue);
}

// --- image compression ---
async function compressImage(file, maxSize = 1024, quality = 0.8) {
  const img = new Image();
  const url = URL.createObjectURL(file);
  img.src = url;
  await new Promise((res, rej) => { img.onload = res; img.onerror = rej; });

  let { width, height } = img;
  const scale = Math.min(1, maxSize / Math.max(width, height));
  width = Math.round(width * scale);
  height = Math.round(height * scale);

  const canvas = document.createElement("canvas");
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, width, height);

  const blob = await new Promise((res) => canvas.toBlob(res, "image/jpeg", quality));
  URL.revokeObjectURL(url);
  return blob;
}

// --- concurrency runner (NEW) ---
async function runWithConcurrency(items, limit, worker) {
  const queue = [...items];
  const runners = Array.from({ length: Math.min(limit, queue.length) }, async () => {
    while (queue.length) {
      const item = queue.shift();
      await worker(item);
    }
  });
  await Promise.all(runners);
}

// --- trade helpers ---
function getMyTradeTotal() {
  let t = 0;
  for (const id of mySelectedIds) {
    const item = inventoryMap.get(id);
    if (!item) continue;
    t += (Number(item.estValue ?? 0) || 0);
  }
  return t;
}
function getTheirTradeTotal() {
  return theirPins.reduce((sum, p) => sum + (Number(p.estValue ?? 0) || 0), 0);
}
function renderTrade() {
  if (mySelectedIds.length === 0) {
    myTradeList.className = "muted";
    myTradeList.textContent = "Select pins from your inventory below.";
  } else {
    myTradeList.className = "";
    myTradeList.innerHTML = mySelectedIds.map(id => {
      const item = inventoryMap.get(id);
      const name = item?.name ?? "Unnamed";
      const val = item?.estValue != null ? fmtMoney(Number(item.estValue)) : "$0.00";
      return `<div class="card" style="margin:8px 0;"><b>${name}</b><div class="muted small">Pin ID: ${id}</div><div>Value: ${val}</div></div>`;
    }).join("");
  }

  if (theirPins.length === 0) {
    theirTradeList.className = "muted";
    theirTradeList.textContent = "No pins added yet.";
  } else {
    theirTradeList.className = "";
    theirTradeList.innerHTML = theirPins.map((p, idx) => {
      const val = fmtMoney(Number(p.estValue ?? 0));
      return `
        <div class="card" style="margin:8px 0;">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <div>
              <b>${p.name || "Unnamed"}</b>
              <div class="muted small">Pin ID: ${p.pinId}</div>
              <div>Value: ${val}</div>
            </div>
            <button data-remove-their="${idx}">Remove</button>
          </div>
        </div>`;
    }).join("");

    theirTradeList.querySelectorAll("button[data-remove-their]").forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = Number(btn.getAttribute("data-remove-their"));
        theirPins.splice(idx, 1);
        renderTrade();
      });
    });
  }

  const myTotal = getMyTradeTotal();
  const theirTotal = getTheirTradeTotal();
  myTotalEl.textContent = fmtMoney(myTotal);
  theirTotalEl.textContent = fmtMoney(theirTotal);

  const diff = theirTotal - myTotal;
  const absDiff = Math.abs(diff);

  let label = "â€”";
  let detail = "";
  if (mySelectedIds.length === 0 && theirPins.length === 0) {
    label = "Add pins to compare.";
  } else if (absDiff <= 2) {
    label = "Fair âœ…";
    detail = `Difference: ${fmtMoney(diff)} (within $2).`;
  } else if (diff > 0) {
    label = "Favors you ðŸ‘";
    detail = `Youâ€™re receiving about ${fmtMoney(absDiff)} more value.`;
  } else {
    label = "Favors them ðŸ‘Ž";
    detail = `Youâ€™re giving about ${fmtMoney(absDiff)} more value.`;
  }

  fairnessText.textContent = label;
  fairnessDetail.textContent = detail;

  completeTradeBtn.disabled = !(mySelectedIds.length >= 1 && theirPins.length >= 1 && mySelectedIds.length <= 3 && theirPins.length <= 3);
}
function resetTrade() {
  mySelectedIds = [];
  theirPins = [];
  renderTrade();
}

// --- realtime inventory ---
function startInventoryListener() {
  if (!uid) {
    inventoryEl.className = "muted";
    inventoryEl.textContent = "Sign in to see your inventory.";
    return;
  }
  if (unsubscribeInventory) { unsubscribeInventory(); unsubscribeInventory = null; }

  inventoryEl.className = "";
  inventoryEl.textContent = "Loading...";

  const invCol = collection(db, "users", uid, "inventory");
  const q = query(invCol, orderBy("updatedAt", "desc"));

  unsubscribeInventory = onSnapshot(q, (snap) => {
    inventoryMap.clear();
    inventoryEl.innerHTML = "";

    if (snap.empty) {
      inventoryEl.className = "muted";
      inventoryEl.textContent = "No inventory yet.";
      updateTotalsFromInventory();
      resetTrade();
      refreshSelectedBtn.disabled = true;
      return;
    }

    snap.forEach((d) => {
      const item = d.data();
      inventoryMap.set(d.id, item);

      const est = item.estValue != null ? fmtMoney(Number(item.estValue)) : "-";
      const yr = item.year != null ? item.year : "-";
      const qt = item.qty != null ? item.qty : 1;
      const cond = fmtCond(item.condition);
      const selected = mySelectedIds.includes(d.id);
      const refreshChecked = refreshSelectedIds.has(d.id);

      const card = document.createElement("div");
      card.className = "card";
      card.style.cursor = "pointer";

      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
          <div>
            <div><b>${item.name ?? "Unnamed Pin"}</b></div>
            <div class="muted">Pin ID: ${d.id}</div>
            <div>Set: ${item.setName ?? "-"}</div>
            <div>Year: ${yr}</div>
            <div>Qty: ${qt}</div>
            <div>Condition: ${cond}</div>
            <div>Est Value: ${est}</div>
            ${item.photoUrl ? `<div class="muted small">Photo: âœ…</div>` : `<div class="muted small">Photo: â€”</div>`}
            ${item.matchStatus ? `<div class="muted small">Match: ${item.matchStatus}</div>` : ``}
          </div>

          <div class="col">
            <label class="small muted">
              <input type="checkbox" data-trade-id="${d.id}" ${selected ? "checked" : ""}/>
              Add to trade
            </label>

            <!-- NEW: refresh checkbox -->
            <label class="small muted">
              <input type="checkbox" data-refresh-id="${d.id}" ${refreshChecked ? "checked" : ""}/>
              Refresh value
            </label>

            <button data-edit-id="${d.id}">Edit</button>
            <button class="danger" data-delete-id="${d.id}">Delete</button>
          </div>
        </div>
      `;

      // trade checkbox
      const cb = card.querySelector(`input[data-trade-id="${d.id}"]`);
      cb.addEventListener("click", (e) => {
        e.stopPropagation();
        const id = d.id;

        if (cb.checked) {
          if (mySelectedIds.length >= 3) {
            cb.checked = false;
            alert("Max 3 pins on your side.");
            return;
          }
          mySelectedIds.push(id);
        } else {
          mySelectedIds = mySelectedIds.filter(x => x !== id);
        }
        renderTrade();
      });

      // NEW: refresh checkbox
      const rcb = card.querySelector(`input[data-refresh-id="${d.id}"]`);
      rcb.addEventListener("click", (e) => {
        e.stopPropagation();
        const id = d.id;
        if (rcb.checked) refreshSelectedIds.add(id);
        else refreshSelectedIds.delete(id);
        refreshSelectedBtn.disabled = !uid || refreshSelectedIds.size === 0;
      });

      // Edit button
      const editBtn = card.querySelector(`[data-edit-id="${d.id}"]`);
      editBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        fillFormFromDoc(d.id, item);
        setFormMode(d.id);
      });

      // Click card to edit
      card.addEventListener("click", (e) => {
        if (e.target && e.target.closest("button")) return;
        if (e.target && e.target.closest("input")) return;
        fillFormFromDoc(d.id, item);
        setFormMode(d.id);
      });

      // Delete
      const delBtn = card.querySelector(`[data-delete-id="${d.id}"]`);
      delBtn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const ok = confirm(`Delete pin ${d.id}?`);
        if (!ok) return;
        await deleteDoc(doc(db, "users", uid, "inventory", d.id));

        // cleanup state
        if (editingPinId === d.id) { setFormMode(null); clearForm(); }
        mySelectedIds = mySelectedIds.filter(x => x !== d.id);
        refreshSelectedIds.delete(d.id);
        refreshSelectedBtn.disabled = !uid || refreshSelectedIds.size === 0;

        renderTrade();
      });

      inventoryEl.appendChild(card);
    });

    updateTotalsFromInventory();
    mySelectedIds = mySelectedIds.filter(id => inventoryMap.has(id));
    for (const id of Array.from(refreshSelectedIds)) {
      if (!inventoryMap.has(id)) refreshSelectedIds.delete(id);
    }
    refreshSelectedBtn.disabled = !uid || refreshSelectedIds.size === 0;
    renderTrade();
  });
}

// --- auth ---
signUpBtn.addEventListener("click", async () => {
  try {
    const email = (authEmail.value || "").trim();
    const password = (authPassword.value || "").trim();
    if (!email || !password) return alert("Email + password required.");
    await createUserWithEmailAndPassword(auth, email, password);
  } catch (e) { console.error(e); alert(e?.message ?? "Sign up failed."); }
});

signInBtn.addEventListener("click", async () => {
  try {
    const email = (authEmail.value || "").trim();
    const password = (authPassword.value || "").trim();
    if (!email || !password) return alert("Email + password required.");
    await signInWithEmailAndPassword(auth, email, password);
  } catch (e) { console.error(e); alert(e?.message ?? "Sign in failed."); }
});

signOutBtn.addEventListener("click", async () => {
  try { await signOut(auth); } catch (e) { console.error(e); alert(e?.message ?? "Sign out failed."); }
});

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    uid = null;
    authStatus.textContent = "Not signed in.";
    signOutBtn.style.display = "none";
    refreshSelectedIds.clear();
    setAddEnabled(false);

    if (unsubscribeInventory) { unsubscribeInventory(); unsubscribeInventory = null; }

    setFormMode(null);
    clearForm();
    inventoryMap.clear();
    inventoryEl.className = "muted";
    inventoryEl.textContent = "Sign in to see your inventory.";

    statUnique.textContent = "-";
    statQty.textContent = "-";
    statValue.textContent = "-";

    resetTrade();
    return;
  }

  uid = user.uid;
  authStatus.textContent = `Signed in: ${user.email ?? ""}`;
  signOutBtn.style.display = "inline-block";
  setAddEnabled(true);

  await setDoc(doc(db, "users", uid),
    { email: user.email ?? null, updatedAt: serverTimestamp() },
    { merge: true }
  );

  startInventoryListener();
  resetTrade();
  setFormMode(null);
});

// cancel edit
cancelEditBtn.addEventListener("click", () => {
  setFormMode(null);
  clearForm();
  addPinStatus.textContent = "";
});

// Add / Save pin
addPinBtn.addEventListener("click", async () => {
  try {
    if (!uid) return alert("Sign in first.");

    const pinId = (pinIdInput.value || "").trim();
    const name = (nameInput.value || "").trim();

    if (!pinId) return alert("Pin ID is required.");
    if (!name) return alert("Name is required.");

    const docId = editingPinId ? editingPinId : pinId;

    const setName = (setInput.value || "").trim();
    const year = numOrNull(yearInput.value);
    const qty = numOrNull(qtyInput.value) ?? 1;
    const estValue = numOrNull(valueInput.value);
    const condition = (conditionInput.value || "").trim() || null;

    addPinStatus.textContent = "Saving...";

    await setDoc(doc(db, "users", uid, "inventory", docId),
      {
        pinId: docId,
        name,
        setName: setName || null,
        year,
        qty,
        estValue,
        condition,
        source: "manual",
        updatedAt: serverTimestamp(),
        ...(editingPinId ? {} : { createdAt: serverTimestamp() })
      },
      { merge: true }
    );

    addPinStatus.textContent = "Saved âœ…";
    setFormMode(null);
    clearForm();
    setTimeout(() => { addPinStatus.textContent = ""; }, 1200);
  } catch (e) {
    console.error(e);
    addPinStatus.textContent = "";
    alert(e?.message ?? "Save failed.");
  }
});

// Photo upload
uploadPhotoBtn.addEventListener("click", async () => {
  try {
    if (!uid) return alert("Sign in first.");
    const pinId = (editingPinId || (pinIdInput.value || "").trim());
    if (!pinId) return alert("Enter Pin ID first (or select a pin to edit).");

    const file = photoInput.files?.[0];
    if (!file) return alert("Choose a photo first.");

    photoStatus.textContent = "Compressing...";
    const jpegBlob = await compressImage(file, 1024, 0.8);

    photoStatus.textContent = "Uploading...";
    const path = `users/${uid}/inventory/${pinId}/main.jpg`;
    const r = storageRef(storage, path);

    await uploadBytes(r, jpegBlob, { contentType: "image/jpeg" });
    const url = await getDownloadURL(r);

    await setDoc(doc(db, "users", uid, "inventory", pinId),
      { photoUrl: url, photoPath: path, updatedAt: serverTimestamp() },
      { merge: true }
    );

    photoPreview.src = url;
    photoPreview.style.display = "block";
    photoStatus.textContent = "Photo saved âœ…";
  } catch (e) {
    console.error(e);
    photoStatus.textContent = "";
    alert(e?.message ?? "Upload failed.");
  }
});

// Search match stub
searchMatchBtn.addEventListener("click", async () => {
  try {
    if (!uid) return alert("Sign in first.");
    const pinId = (editingPinId || (pinIdInput.value || "").trim());
    if (!pinId) return alert("Enter Pin ID first (or select a pin to edit).");

    const item = inventoryMap.get(pinId);
    if (!item?.photoUrl) return alert("Upload a photo first.");

    await setDoc(doc(db, "users", uid, "inventory", pinId),
      {
        matchStatus: "pending",
        matchSource: "stub",
        matchRequestedAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      },
      { merge: true }
    );

    alert("Search match is stubbed. Next step is Cloud Functions for real match + comps.");
  } catch (e) { console.error(e); alert(e?.message ?? "Search match failed."); }
});

// NEW: Refresh selected values (calls Cloud Function)
refreshSelectedBtn.addEventListener("click", async () => {
  if (!uid) return alert("Sign in first.");
  const ids = Array.from(refreshSelectedIds);
  if (ids.length === 0) return;

  refreshSelectedBtn.disabled = true;
  refreshStatus.textContent = `Refreshing ${ids.length} pin(s)...`;

  let ok = 0;
  let fail = 0;

  await runWithConcurrency(ids, 3, async (pinDocId) => {
    try {
      await refreshPinValue({ pinDocId });
      ok++;
    } catch (e) {
      console.error("refresh failed", pinDocId, e);
      fail++;
    }
    refreshStatus.textContent = `Refreshing... (${ok} ok, ${fail} failed)`;
  });

  refreshStatus.textContent = `Done âœ… (${ok} updated, ${fail} failed)`;
  refreshSelectedBtn.disabled = !uid || refreshSelectedIds.size === 0;
});

// Their pins add
addTheirBtn.addEventListener("click", () => {
  const pid = (theirPinId.value || "").trim();
  const nm = (theirName.value || "").trim();
  const val = numOrNull(theirValue.value);

  if (!pid) return alert("Their Pin ID is required.");
  if (theirPins.length >= 3) return alert("Max 3 pins on their side.");

  theirPins.push({ pinId: pid, name: nm, estValue: val ?? 0 });

  theirPinId.value = "";
  theirName.value = "";
  theirValue.value = "";

  renderTrade();
});

// Reset trade
resetTradeBtn.addEventListener("click", () => resetTrade());

// Complete trade
completeTradeBtn.addEventListener("click", async () => {
  if (!uid) return alert("Sign in first.");
  if (mySelectedIds.length < 1 || theirPins.length < 1) return;

  const myTotal = getMyTradeTotal();
  const theirTotal = getTheirTradeTotal();
  const diff = theirTotal - myTotal;

  const msg =
    `Complete trade?\n\n` +
    `My pins: ${mySelectedIds.length} (total ${fmtMoney(myTotal)})\n` +
    `Their pins: ${theirPins.length} (total ${fmtMoney(theirTotal)})\n` +
    `Difference (their - mine): ${fmtMoney(diff)}\n\n` +
    `This will update your inventory.\n`;

  const ok = confirm(msg);
  if (!ok) return;

  try {
    // decrement my pins
    for (const id of mySelectedIds) {
      const item = inventoryMap.get(id);
      if (!item) continue;

      const currentQty = Number(item.qty ?? 1) || 1;
      const newQty = currentQty - 1;

      if (newQty <= 0) {
        await deleteDoc(doc(db, "users", uid, "inventory", id));
      } else {
        await setDoc(doc(db, "users", uid, "inventory", id),
          { qty: newQty, updatedAt: serverTimestamp() }, { merge: true });
      }
    }

    // add/increment their pins
    for (const p of theirPins) {
      const id = p.pinId;
      const existing = inventoryMap.get(id);
      const currentQty = Number(existing?.qty ?? 0) || 0;
      const newQty = currentQty + 1;

      await setDoc(
        doc(db, "users", uid, "inventory", id),
        {
          pinId: id,
          name: (existing?.name ?? p.name ?? "Unnamed"),
          setName: existing?.setName ?? null,
          year: existing?.year ?? null,
          condition: existing?.condition ?? null,
          estValue: (existing?.estValue ?? p.estValue ?? null),
          qty: newQty,
          source: "trade",
          updatedAt: serverTimestamp(),
          ...(existing ? {} : { createdAt: serverTimestamp() })
        },
        { merge: true }
      );
    }

    resetTrade();
    alert("Trade completed âœ…");
  } catch (e) {
    console.error(e);
    alert(e?.message ?? "Trade failed.");
  }
});

// init
renderTrade();
setFormMode(null);
</script>

</body>
</html>